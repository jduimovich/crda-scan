# CI Test - Build the action container
# build test container which has default test files and validate
name: CI-PR
on: [pull_request]  
jobs:
  test:
    runs-on: ubuntu-latest
    name: CRDA Scan
    steps: 
      - name: Checkout
        uses: actions/checkout@v2 
      - name: Run CRDA and Convert to Sarif
        uses: jduimovich/crda-sarif-poc@main
        with:
          input-file-name: package.json
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          output-file-name: crda.sarif
      - name: Show CRDA and Sarif outputs
        run: |  
          echo CRDA JSON output
          cat crda.json  | jq 
          echo CRDA sarif output
          cat crda.sarif  | jq 
          set TV=$(cat crda.json | jq .total_direct_vulnerabilities)
          if [ "$TV" -neq "0" ]; then
            echo "FAILED";
            exit $TV;
          fi